<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BON Cafe - Employee Portal</title>
    <style>
        :root {
            --primary: #F68B1F; /* BON Cafe Orange */
            --dark: #333333;    /* Grey */
            --light: #F4F4F4;   /* Light Grey */
            --white: #FFFFFF;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background-color: var(--light); color: var(--dark); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn {
            background-color: var(--primary); color: var(--white);
            border: none; padding: 10px 20px; cursor: pointer;
            border-radius: 5px; font-weight: bold; transition: 0.3s;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* --- LOGIN / REGISTER --- */
        .auth-container {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg, var(--dark), #1a1a1a);
        }
        .auth-box {
            background: var(--white); padding: 40px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px;
            text-align: center; border-top: 5px solid var(--primary);
        }
        .auth-box h2 { color: var(--primary); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.9em; margin-bottom: 5px; }
        .input-group input {
            width: 100%; padding: 10px; border: 1px solid #ccc;
            border-radius: 4px; outline: none;
        }
        .input-group input:focus { border-color: var(--primary); }
        .link { color: var(--primary); cursor: pointer; font-size: 0.9em; margin-top: 10px; display: block; }

        /* --- DASHBOARD --- */
        header {
            background: var(--dark); color: var(--white); padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        
        .main-container { padding: 30px; max-width: 1200px; margin: 0 auto; }
        
        /* Grid System */
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .card {
            background: var(--white); padding: 30px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;
            transition: 0.3s; cursor: pointer; border-bottom: 4px solid transparent;
        }
        .card:hover { transform: translateY(-5px); border-bottom-color: var(--primary); }
        .card h3 { color: var(--dark); margin-bottom: 10px; }
        .card i { font-size: 2rem; color: var(--primary); margin-bottom: 15px; }

        /* --- PROFILE SECTION --- */
        .profile-container {
            background: var(--white); padding: 30px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid var(--light); padding-bottom: 20px;}
        .profile-pic-box {
            width: 100px; height: 100px; border-radius: 50%; background: #eee;
            background-size: cover; background-position: center; border: 3px solid var(--primary);
        }
        .form-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        @media(max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }

        /* --- TRAINING SECTION --- */
        .training-category { margin-bottom: 30px; }
        .training-item {
            background: var(--white); padding: 15px; margin-bottom: 10px;
            border-left: 4px solid var(--primary); display: flex; justify-content: space-between;
        }
        
        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 999;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <!-- LOADER -->
    <div id="loader" class="hidden"><div class="spinner"></div></div>

    <!-- LOGIN PAGE -->
    <div id="login-page" class="auth-container">
        <div class="auth-box">
            <h2>BON Cafe Portal</h2>
            <form id="login-form">
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="login-user" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="login-pass" required>
                </div>
                <button type="submit" class="btn" style="width:100%">LOGIN</button>
            </form>
            <span class="link" onclick="showPage('register-page')">Create an Account</span>
        </div>
    </div>

    <!-- REGISTER PAGE -->
    <div id="register-page" class="auth-container hidden">
        <div class="auth-box">
            <h2>Register Employee</h2>
            <form id="register-form">
                <div class="input-group"><input type="text" id="reg-name" placeholder="Full Name" required></div>
                <div class="input-group"><input type="text" id="reg-id" placeholder="Employee ID" required></div>
                <div class="input-group"><input type="email" id="reg-email" placeholder="Email" required></div>
                <div class="input-group"><input type="text" id="reg-user" placeholder="Username" required></div>
                <div class="input-group"><input type="password" id="reg-pass" placeholder="Password" required></div>
                <button type="submit" class="btn" style="width:100%">REGISTER</button>
            </form>
            <span class="link" onclick="showPage('login-page')">Back to Login</span>
        </div>
    </div>

    <!-- MAIN APP (Protected) -->
    <div id="app-container" class="hidden">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fas fa-coffee" style="color:var(--primary)"></i>
                <h1>BON Cafe</h1>
            </div>
            <div>
                <span id="welcome-msg" style="margin-right:15px; font-size:0.9rem"></span>
                <button onclick="logout()" class="btn-outline" style="padding: 5px 10px; font-size: 0.8rem">Logout</button>
            </div>
        </header>

        <div class="main-container">
            
            <!-- HOME / DASHBOARD -->
            <div id="home-section">
                <h2>Welcome back!</h2>
                <div class="card-grid">
                    <div class="card" onclick="openSection('profile-section')">
                        <i class="fas fa-user-circle"></i>
                        <h3>Employee Profile</h3>
                        <p>View and edit your personal information.</p>
                    </div>
                    <div class="card" onclick="openSection('dashboard-section')">
                        <i class="fas fa-chart-line"></i>
                        <h3>My Dashboard</h3>
                        <p>Check your work progress and stats.</p>
                    </div>
                    <div class="card" onclick="openSection('training-section')">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Trainings</h3>
                        <p>Access new and existing employee modules.</p>
                    </div>
                </div>
            </div>

            <!-- PROFILE SECTION -->
            <div id="profile-section" class="hidden">
                <button class="btn-outline" onclick="openSection('home-section')" style="margin-bottom:20px">&larr; Back</button>
                <div class="profile-container">
                    <div class="profile-header">
                        <div id="profile-pic-display" class="profile-pic-box"></div>
                        <div>
                            <h2 id="display-name">Employee Name</h2>
                            <p id="display-id" style="color:#777">ID: ---</p>
                        </div>
                    </div>

                    <form id="profile-form">
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Profile Picture</label>
                                <input type="file" id="p-pic-upload" accept="image/*">
                            </div>
                            <div class="input-group"><label>Iqama Number</label><input type="text" id="p-iqama"></div>
                            <div class="input-group"><label>Mobile Number</label><input type="text" id="p-mobile"></div>
                            <div class="input-group"><label>Current Branch</label><input type="text" id="p-branch"></div>
                            <div class="input-group"><label>Nationality</label><input type="text" id="p-nationality"></div>
                            <div class="input-group"><label>Age</label><input type="number" id="p-age"></div>
                            <div class="input-group">
                                <label>Status</label>
                                <select id="p-status" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                                    <option value="Single">Single</option>
                                    <option value="Married">Married</option>
                                </select>
                            </div>
                            <div class="input-group"><label>Educational Background</label><input type="text" id="p-edu"></div>
                            <div class="input-group"><label>Years at BON Cafe</label><input type="text" id="p-years"></div>
                            <div class="input-group"><label>Date Started</label><input type="date" id="p-start"></div>
                        </div>
                        <br>
                        <button type="submit" class="btn">Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- TRAINING SECTION -->
            <div id="training-section" class="hidden">
                <button class="btn-outline" onclick="openSection('home-section')" style="margin-bottom:20px">&larr; Back</button>
                
                <div class="training-category">
                    <h3 style="color:var(--primary)">New Employee Training</h3>
                    <div class="training-item">
                        <span>1. Introduction to BON Cafe Culture</span>
                        <button class="btn-outline" style="padding:2px 10px; font-size:0.8rem">Start</button>
                    </div>
                    <div class="training-item">
                        <span>2. Basic Barista Skills & Safety</span>
                        <button class="btn-outline" style="padding:2px 10px; font-size:0.8rem">Start</button>
                    </div>
                </div>

                <div class="training-category">
                    <h3 style="color:var(--primary)">Existing Employee Training</h3>
                    <div class="training-item">
                        <span>1. Advanced Latte Art</span>
                        <button class="btn-outline" style="padding:2px 10px; font-size:0.8rem">Start</button>
                    </div>
                    <div class="training-item">
                        <span>2. Customer Service Excellence Refresher</span>
                        <button class="btn-outline" style="padding:2px 10px; font-size:0.8rem">Start</button>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD SECTION (Progress) -->
            <div id="dashboard-section" class="hidden">
                <button class="btn-outline" onclick="openSection('home-section')" style="margin-bottom:20px">&larr; Back</button>
                <div class="card-grid">
                    <div class="card">
                        <h1>85%</h1>
                        <p>Training Completion</p>
                    </div>
                    <div class="card">
                        <h1>12</h1>
                        <p>Shifts this Month</p>
                    </div>
                    <div class="card">
                        <h1>Excellent</h1>
                        <p>Manager Rating</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // *** CONFIGURATION ***
        // PASTE YOUR NEW "ANYONE" URL HERE
        const API_URL = "https://script.google.com/macros/s/AKfycbwNkD3VNQUPzjVyK058JUBYImkqBJhsOUPn-Ssc2x7GA2o1IGsJuNkun1wROw4eQfnVQg/exec"; 

        // *** STATE MANAGEMENT ***
        let currentUser = null;
        let currentProfile = {};

        // *** NAVIGATION ***
        function showPage(id) {
            document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'home-section') document.getElementById('loader').classList.add('hidden');
        }

        function openSection(id) {
            ['home-section', 'profile-section', 'training-section', 'dashboard-section'].forEach(sec => {
                document.getElementById(sec).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleLoader(show) {
            const loader = document.getElementById('loader');
            if(show) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        // *** API HELPER (The Fix) ***
        // We send data as text/plain to avoid CORS Preflight checks from Google
        function sendRequest(data) {
            return fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
                body: JSON.stringify(data),
            }).then((res) => res.json());
        }

        // *** AUTHENTICATION ***
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;

            toggleLoader(true);
            
            sendRequest({ action: 'login', username: u, password: p })
            .then(data => {
                toggleLoader(false);
                if(data.status === 'success') {
                    currentUser = data.username;
                    document.getElementById('welcome-msg').innerText = "Hello, " + data.name;
                    document.getElementById('display-name').innerText = data.name;
                    
                    if(data.profile && data.profile !== "{}") {
                        currentProfile = JSON.parse(data.profile);
                        populateProfileForm(currentProfile);
                    }
                    
                    showPage('app-container');
                    openSection('home-section');
                } else {
                    alert(data.message);
                }
            })
            .catch(err => { 
                toggleLoader(false); 
                console.error(err);
                alert("Connection Error. Check Console (F12) or Deployment Permissions."); 
            });
        });

        document.getElementById('register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                action: 'register',
                name: document.getElementById('reg-name').value,
                id: document.getElementById('reg-id').value,
                email: document.getElementById('reg-email').value,
                username: document.getElementById('reg-user').value,
                password: document.getElementById('reg-pass').value
            };

            toggleLoader(true);
            sendRequest(data)
            .then(data => {
                toggleLoader(false);
                if(data.status === 'success') {
                    alert("Registration Successful! Please Login.");
                    showPage('login-page');
                } else {
                    alert(data.message);
                }
            })
            .catch(err => {
                toggleLoader(false);
                alert("Registration Failed. Check connection.");
            });
        });

        function logout() {
            currentUser = null;
            currentProfile = {};
            document.getElementById('login-form').reset();
            showPage('login-page');
        }

        // *** PROFILE LOGIC ***
        function populateProfileForm(data) {
            if(data.pic) document.getElementById('profile-pic-display').style.backgroundImage = `url(${data.pic})`;
            if(data.iqama) document.getElementById('p-iqama').value = data.iqama;
            if(data.mobile) document.getElementById('p-mobile').value = data.mobile;
            if(data.branch) document.getElementById('p-branch').value = data.branch;
            if(data.nationality) document.getElementById('p-nationality').value = data.nationality;
            if(data.age) document.getElementById('p-age').value = data.age;
            if(data.status) document.getElementById('p-status').value = data.status;
            if(data.edu) document.getElementById('p-edu').value = data.edu;
            if(data.years) document.getElementById('p-years').value = data.years;
            if(data.start) document.getElementById('p-start').value = data.start;
        }

        document.getElementById('profile-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('p-pic-upload');
            let base64Img = currentProfile.pic || "";

            const saveProfile = (imgData) => {
                const profileData = {
                    pic: imgData,
                    iqama: document.getElementById('p-iqama').value,
                    mobile: document.getElementById('p-mobile').value,
                    branch: document.getElementById('p-branch').value,
                    nationality: document.getElementById('p-nationality').value,
                    age: document.getElementById('p-age').value,
                    status: document.getElementById('p-status').value,
                    edu: document.getElementById('p-edu').value,
                    years: document.getElementById('p-years').value,
                    start: document.getElementById('p-start').value
                };

                toggleLoader(true);
                sendRequest({
                    action: 'updateProfile',
                    username: currentUser,
                    profileData: profileData
                })
                .then(data => {
                    toggleLoader(false);
                    if(data.status === 'success') {
                        currentProfile = profileData;
                        populateProfileForm(profileData);
                        alert("Profile Saved!");
                    } else {
                        alert("Error saving profile.");
                    }
                });
            };

            if(fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveProfile(e.target.result);
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveProfile(base64Img);
            }
        });

        // Initialize
        showPage('login-page');
    </script>
</body>
</html>
